import machine
import time

class ST7796S:
    def __init__(self, spi, dc, rst, cs, width=480, height=320):
        self.spi = spi
        self.dc = dc
        self.rst = rst
        self.cs = cs
        self.width = width
        self.height = height

        self.dc.init(machine.Pin.OUT)
        self.rst.init(machine.Pin.OUT)
        self.cs.init(machine.Pin.OUT)

        self.reset()
        self.init_display()

    def reset(self):
        self.rst(1)
        time.sleep_ms(5)
        self.rst(0)
        time.sleep_ms(10)
        self.rst(1)
        time.sleep_ms(120)

    def write_cmd(self, cmd):
        self.dc(0)
        self.cs(0)
        self.spi.write(bytearray([cmd]))
        self.cs(1)

    def write_data(self, data):
        self.dc(1)
        self.cs(0)
        self.spi.write(bytearray([data]))
        self.cs(1)

    def write_data_16bit(self, data):
        self.dc(1)
        self.cs(0)
        self.spi.write(bytearray([data >> 8, data & 0xFF]))
        self.cs(1)

    def init_display(self):
        self.write_cmd(0x01)  # Software reset
        time.sleep_ms(150)

        self.write_cmd(0x11)  # Sleep out
        time.sleep_ms(255)

        self.write_cmd(0x3A)  # Interface Pixel Format
        self.write_data(0x55)  # 16 bits per pixel

        # Set the display to Landscape mode (0xE8)
        self.write_cmd(0x36)  # MADCTL
        self.write_data(0xE8)  # Landscape mode

        self.write_cmd(0x29)  # Display on
        time.sleep_ms(100)

    def set_window(self, x0, y0, x1, y1):
        self.write_cmd(0x2A)  # Column address set
        self.write_data_16bit(x0)
        self.write_data_16bit(x1)

        self.write_cmd(0x2B)  # Row address set
        self.write_data_16bit(y0)
        self.write_data_16bit(y1)

        self.write_cmd(0x2C)  # Memory write

    def draw_pixel(self, x, y, color):
        self.set_window(x, y, x, y)
        self.write_data_16bit(color)

    def fill_screen(self, color):
        self.set_window(0, 0, self.width - 1, self.height - 1)
        for _ in range(self.width * self.height):
            self.write_data_16bit(color)

    def draw_char(self, x, y, char, color, bg_color):
        """
        Draw an 8x8 character.
        """
        if char in self.font:
            char_data = self.font[char]
            for row in range(8):
                for col in range(8):
                    if char_data[row] & (1 << (7 - col)):
                        self.draw_pixel(x + col, y + row, color)
                    else:
                        self.draw_pixel(x + col, y + row, bg_color)

    def draw_text(self, x, y, text, color, bg_color):
        """
        Draw text using the 8x8 font.
        """
        for i, char in enumerate(text):
            self.draw_char(x + i * 8, y, char, color, bg_color)
    # 8x8 font data for uppercase, lowercase, digits, and punctuation
    font = {
        'A': [
            0b00110000,
            0b01111000,
            0b11001100,
            0b11001100,
            0b11111100,
            0b11001100,
            0b11001100,
            0b00000000
        ],
        'B': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b00000000
        ],
        'C': [
            0b01111000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b01111000,
            0b00000000
        ],
        'D': [
            0b11110000,
            0b11011000,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11011000,
            0b11110000,
            0b00000000
        ],
        'E': [
            0b11111100,
            0b11000000,
            0b11000000,
            0b11111000,
            0b11000000,
            0b11000000,
            0b11111100,
            0b00000000
        ],
        'F': [
            0b11111100,
            0b11000000,
            0b11000000,
            0b11111000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b00000000
        ],
        'G': [
            0b01111000,
            0b11000000,
            0b11000000,
            0b11011100,
            0b11001100,
            0b11001100,
            0b01111100,
            0b00000000
        ],
        'H': [
            0b11001100,
            0b11001100,
            0b11111100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b00000000
        ],
        'I': [
            0b11111100,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b11111100,
            0b00000000
        ],
        'J': [
            0b11111100,
            0b00001100,
            0b00001100,
            0b00001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'K': [
            0b11001100,
            0b11011000,
            0b11110000,
            0b11100000,
            0b11110000,
            0b11011000,
            0b11001100,
            0b00000000
        ],
        'L': [
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11111100,
            0b00000000
        ],
        'M': [
            0b11001100,
            0b11111100,
            0b11111100,
            0b11011000,
            0b11011000,
            0b11011000,
            0b11011000,
            0b00000000
        ],
        'N': [
            0b11001100,
            0b11111100,
            0b11111100,
            0b11011000,
            0b11011000,
            0b11011000,
            0b11001100,
            0b00000000
        ],
        'O': [
            0b01111000,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'P': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b00000000
        ],
        'Q': [
            0b01111000,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11010100,
            0b01111010,
            0b00000000
        ],
        'R': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11011000,
            0b11001100,
            0b11001100,
            0b00000000
        ],
        'S': [
            0b01111000,
            0b11000000,
            0b11000000,
            0b01111000,
            0b00001100,
            0b00001100,
            0b11111000,
            0b00000000
        ],
        'T': [
            0b11111100,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00000000
        ],
        'U': [
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'V': [
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00110000,
            0b00000000
        ],
        'W': [
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11011000,
            0b11111100,
            0b11111100,
            0b00000000
        ],
        'X': [
            0b11001100,
            0b11001100,
            0b01111000,
            0b00110000,
            0b01111000,
            0b11001100,
            0b11001100,
            0b00000000
        ],
        'Y': [
            0b11001100,
            0b11001100,
            0b01111000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00000000
        ],
        'Z': [
            0b11111100,
            0b00001100,
            0b00011000,
            0b00110000,
            0b01100000,
            0b11000000,
            0b11111100,
            0b00000000
        ],
        'a': [
            0b01111000,
            0b00001100,
            0b01111000,
            0b10001100,
            0b10001100,
            0b01111100,
            0b00000000,
            0b00000000
        ],
        'b': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b00000000
        ],
        'c': [
            0b01111000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b01111000,
            0b00000000,
            0b00000000
        ],
        'd': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b00000000
        ],
        'e': [
            0b01111000,
            0b11000000,
            0b11111000,
            0b11000000,
            0b11000000,
            0b01111000,
            0b00000000,
            0b00000000
        ],
        'f': [
            0b01111000,
            0b11000000,
            0b11111000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b00000000
        ],
        'g': [
            0b01111100,
            0b11000000,
            0b11000000,
            0b01111100,
            0b00001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'h': [
            0b11001100,
            0b11001100,
            0b11111000,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b00000000
        ],
        'i': [
            0b01111100,
            0b00001100,
            0b00001100,
            0b00001100,
            0b00001100,
            0b00001100,
            0b01111100,
            0b00000000
        ],
        'j': [
            0b11111100,
            0b00001100,
            0b00001100,
            0b00001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'k': [
            0b11001100,
            0b11011000,
            0b11110000,
            0b11100000,
            0b11110000,
            0b11011000,
            0b11001100,
            0b00000000
        ],
        'l': [
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b11111100,
            0b00000000
        ],
        'm': [
            0b11111100,
            0b11011000,
            0b11011000,
            0b11111100,
            0b11011000,
            0b11011000,
            0b11011000,
            0b00000000
        ],
        'n': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11001100,
            0b11001100,
            0b11001100,
            0b00000000
        ],
        'o': [
            0b01111000,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'p': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b00000000
        ],
        'q': [
            0b01111100,
            0b11000000,
            0b11000000,
            0b01111100,
            0b00001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'r': [
            0b11111000,
            0b11001100,
            0b11001100,
            0b11111000,
            0b11000000,
            0b11000000,
            0b11000000,
            0b00000000
        ],
        's': [
            0b01111000,
            0b11000000,
            0b11000000,
            0b01111000,
            0b00001100,
            0b00001100,
            0b11111000,
            0b00000000
        ],
        't': [
            0b11111100,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00000000
        ],
        'u': [
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        'v': [
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00110000,
            0b00000000
        ],
        'w': [
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11011000,
            0b11111100,
            0b11111100,
            0b00000000
        ],
        'x': [
            0b11001100,
            0b11001100,
            0b01111000,
            0b00110000,
            0b01111000,
            0b11001100,
            0b11001100,
            0b00000000
        ],
        'y': [
            0b11001100,
            0b11001100,
            0b01111000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00000000
        ],
        'z': [
            0b11111100,
            0b00001100,
            0b00011000,
            0b00110000,
            0b01100000,
            0b11000000,
            0b11111100,
            0b00000000
        ],
        '0': [
            0b01111000,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        '1': [
            0b00110000,
            0b01110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b11111100,
            0b00000000
        ],
        '2': [
            0b01111000,
            0b11001100,
            0b00001100,
            0b00111000,
            0b01100000,
            0b11000000,
            0b11111100,
            0b00000000
        ],
        '3': [
            0b11111000,
            0b11001100,
            0b00001100,
            0b00111000,
            0b00001100,
            0b11001100,
            0b11111000,
            0b00000000
        ],
        '4': [
            0b00111000,
            0b01111000,
            0b11111000,
            0b00011000,
            0b00011000,
            0b00011000,
            0b00011000,
            0b00000000
        ],
        '5': [
            0b11111100,
            0b11000000,
            0b11000000,
            0b11111000,
            0b00001100,
            0b00001100,
            0b11111000,
            0b00000000
        ],
        '6': [
            0b01111000,
            0b11000000,
            0b11000000,
            0b11111000,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        '7': [
            0b11111100,
            0b00001100,
            0b00011000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00110000,
            0b00000000
        ],
        '8': [
            0b01111000,
            0b11001100,
            0b11001100,
            0b01111000,
            0b11001100,
            0b11001100,
            0b01111000,
            0b00000000
        ],
        '9': [
            0b01111000,
            0b11001100,
            0b11001100,
            0b01111100,
            0b00001100,
            0b00001100,
            0b11111000,
            0b00000000
        ],
        '.': [
            0b00000000,
            0b00000000,
            0b00000000,
            0b00000000,
            0b00000000,
            0b00011000,
            0b00011000,
            0b00000000
        ],
        ',': [
            0b00000000,
            0b00000000,
            0b00000000,
            0b00000000,
            0b00011000,
            0b00011000,
            0b00010000,
            0b00000000
        ],
        '+': [
            0b00011000,
            0b00011000,
            0b11111100,
            0b00011000,
            0b00011000,
            0b00011000,
            0b00011000,
            0b00000000
        ],
        '-': [
            0b00000000,
            0b00000000,
            0b11111100,
            0b00000000,
            0b00000000,
            0b00000000,
            0b00000000,
            0b00000000
        ],
        '=': [
            0b00000000,
            0b11111100,
            0b00000000,
            0b11111100,
            0b00000000,
            0b00000000,
            0b00000000,
            0b00000000
        ],
        '/': [
            0b00000110,
            0b00001100,
            0b00011000,
            0b00110000,
            0b01100000,
            0b11000000,
            0b10000000,
            0b00000000
        ],
        '*': [
            0b00110000,
            0b01111000,
            0b11111100,
            0b01111000,
            0b00110000,
            0b00000000,
            0b00000000,
            0b00000000
        ],
        '%': [
            0b11000110,
            0b11001100,
            0b00011000,
            0b00110000,
            0b01100000,
            0b11001100,
            0b11000110,
            0b00000000
        ]
    }
